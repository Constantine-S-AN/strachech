# 常见坑：幸存者偏差、未来函数、成本假设

这份清单聚焦三类最常见、最容易让回测结果“看起来很美”的问题。每一类都给出：

- 典型症状
- 错误做法
- 更安全做法
- 快速自检

## 1) 幸存者偏差（Survivorship Bias）

### 典型症状

- 历史收益曲线长期平滑向上，回撤异常小
- 换一个时间区间后，表现明显退化
- 只在“今天还活着的标的池”上回测时表现最好

### 错误做法

- 用当前成分股直接回放 5-10 年历史，不处理历史成分变化
- 忽略退市、并购、停牌样本

### 更安全做法

- 使用 point-in-time（按历史时点）成分数据
- 纳入退市样本，保证“当时可投 universe”被正确重建
- 报告中单独输出 universe 变化统计，避免样本静态假设

### 快速自检

- 对比“静态成分池”与“时点成分池”两份结果
- 检查回测日志中是否记录成分变化/样本删除原因
- 观察 `Regime Scorecard` 与窗口指标是否在样本切换处异常跃迁

## 2) 未来函数（Lookahead Bias）

### 典型症状

- 信号命中率异常高，几乎“每次都买在低点”
- 延迟一根 bar 后，策略性能显著崩塌
- 实盘/纸面交易表现远差于回测

### 错误做法

- 在当前 bar 生成信号时使用了未来价格
- 使用 `rolling` 后未处理对齐，导致未来值泄漏
- 直接用 `close` 计算信号并在同一 `close` 成交（无执行延迟）

### 更安全做法

- 明确“信号时点”和“成交时点”分离（至少一根 bar 延迟）
- 所有特征在下单时必须仅依赖当下可见信息
- 对关键字段统一做时间戳对齐检查，并留审计日志

### 快速自检

- 将策略整体 `shift(1)` 后重跑，若结果断崖式下滑，优先排查未来函数
- 在 `Execution Quality` 查看 `Avg/Median Latency Bars`，确认非不合理的零延迟
- 审核特征工程代码，确保不存在未来窗口引用

## 3) 成本假设失真（Cost Assumption Risk）

### 典型症状

- 只在零手续费/零滑点下高收益
- 交易频率越高，回测越“完美”
- 轻微提高成本后 Sharpe 和 CAGR 急剧恶化

### 错误做法

- 手续费、滑点、点差固定为 0
- 忽略冲击成本和流动性约束
- 不做成本敏感性扫描就下结论

### 更安全做法

- 使用合理的 `commission_bps`、`slippage_bps`、`spread_bps`
- 将成本区间作为“稳健性维度”，而非单点假设
- 对高换手策略额外做冲击/成交约束压力测试

### 快速自检

- 查看报告 `Cost/Slippage Sensitivity`：指标是否随成本上升平滑退化
- 对比 `twap_slices = 1` 与多切片执行下的 `Execution Quality`
- 把最差窗口表现与成本高位组合联动检查，避免只看均值

## 最小实践建议

在提交策略结论前，至少完成以下三件事：

1. 跑 `healthcheck` 并检查最差窗口，不只看全样本均值
2. 检查 `Regime Scorecard`，确认策略不是只在单一市场状态有效
3. 检查 `Cost/Slippage Sensitivity` 与 `Execution Quality`，确认执行可落地
